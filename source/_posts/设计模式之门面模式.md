---
layout:    post
title:     设计模式之门面模式
category:  设计模式之美
description: 设计模式之门面模式
tags: 设计模式之美
---

为了保证接口的可复用性，我们需要将接口尽量设计得细粒度一点，指责单一一点。但是，如果接口粒度过小，在接口的使用者开发一个业务功能时，就会导致需要调用n多细粒度的接口才能完成。调用者肯定会抱怨接口不好用。

相反，如果接口粒度设计的太大，一个接口返回n多数据，要做n多事情，就会导致接口不够通用、可复用性不好。接口不可复用，那针对不同调用者的业务需求，我们就需要开发不同的接口来满足，这就回导致系统的接口无限膨胀。

##### 门面模式的原理与实现

门面模式，也叫外观模式，英文全称是Facade Design Pattern。Gof的《设计模式》书中，门面模式是这样定义的：

> Provide a unified interface to a set of interfaces in a subsystem.Facade Pattern defines a higher-level interface that makes the subsystem easier to use.

翻译成中文就是：门面模式为子系统提供一组统一的接口，定义一组高层接口让子系统更易用。

假设有一个系统A，提供了a、b、c、d四个接口。系统B完成某个业务功能，需要调用A系统的a、b、d接口。利用门面模式，我们提供一个包裹a、b、d接口调用的门面接口x，给系统B直接使用。

可能感觉让系统B直接调用a、b、d没什么太大问题，为什么还要提供一个包裹a、b、d的接口x呢。

假设系统A是后端服务器，系统B是App客户端。App客户端通过后端服务器提供的接口来获取数据。我们知道，App和服务器之间是通过移动网络通信的，网络通信耗时比较多，为了提高App的响应速度，我们要尽量减少App与服务器之间的网络通信次数。

假设，完成某个业务功能（比如现实某个页面信息）需要“依次”调用a、b、d三个接口，因自身业务的特点，不支持并发调用这三个接口。

如果我们现在发现App客户端响应速度比较慢，排查后发现，是因为过多的接口调用过多的网络通信。我们就可以利用门面模式，提供一个包含a、b、d三个接口调用的接口x。客户端通过调用一次接口x，来获取到所有想要的数据，将网络通信的次数从3次减少到1次，也就提高了App的响应速度。

##### 门面模式的应用场景举例

门面模式让子系统更加易用，实际上，它出了解决易用性问题之外，还能考虑其他很多方面的问题。门面模式定义中的“子系统”也可以有多种理解方式。它既可以是一个完整的系统，也可以是更细粒度的类或者模块。

1.解决易用性问题

门面模式可以用来封装系统的底层实现，隐藏系统的复杂性，提供一组更加简单易用、更高层的接口。比如，Linux系统调用函数就可以看作一种“门面”。它是Linux操作系统暴露给开发者的一组“特殊”的编程接口，它封装了底层更基础的Linux内核调用。Linux的Shell命令，实际上也可以看作一种门面模式的应用。它封装系统调用，提供更加友好、简单的命令，让我们可以直接通过执行命令跟操作系统交互。

门面模式有点类似之前讲的迪米特法则（最少知识原则）和接口隔离原则：两个有交互的系统，只暴露有限的必要的接口。除此之外，门面模式还有点类似之前说的封装、抽象的设计思想，提供更抽象的接口，封装底层实现细节。

2.解决性能问题

刚刚的例子已经讲到了。通过将多个接口调用替换为一个门面接口调用，减少网络通信成本，提高App客户端的响应速度。从代码实现的角度来看，如何组织门面接口和非门面接口？

如果门面接口不多，完全可以将它跟非门面接口放到一起，也不需要特殊标记，当作普通接口来用即可。如果门面接口很多，可以在已有的接口之上，再重新抽象出一层，专门放置门面接口，从类、包的命名上跟原来的接口层做区分。如果门面接口特别多，并且很多都是跨多个子系统的，可以将门面接口放到一个新的子系统中。

3.解决分布式事务问题

通过一个例子解释一下。

在一个金融系统中，有两个业务领域模型，用户和钱包。这两个业务领域模型都对外暴露了一系列接口，比如用户的增删改查接口、钱包的增删改查接口。假设有这样一个业务场景：在用户注册的时候，我们不仅会创建用户（在数据库User表中），还会给用户创建一个钱包（在数据库Wallet表中）。

对于这样一个简单的业务需求，我们可以通过依次调用用户的创建接口和钱包的创建接口来完成。但是，用户注册需要事务，也就是说，创建用户和钱包的两个操作，要么都成功，要么都失败，不能一个成功、一个失败。

要支持两个接口调用在一个事务中执行，是比较难实现的，这涉及分布式事务问题。虽然可以通过引入分布式事务框架或者事后补偿的机制来解决，但代码实现都比较复杂。最简单的方案是，利用数据库事务或者Spring框架提供的事务，在一个事务中，执行创建用户和创建钱包这两个SQL操作。这就要求两个SQL操作要在一个接口中完成，所以我们可以借鉴门面模式的思想，再设计一个包裹这两个操作的新接口，让新接口在一个事务中执行两个SQL操作。

类、模块、系统之间的“通信”，一般都是通过接口调用来完成的。接口设计的好坏，直接影响到类、模块、系统是否好用。所以，要多花点心思在接口设计上。完成接口设计，就相当于完成了一半的开发任务，只要接口设计得好，代码就差不到哪里去。

接口的可复用性和易用性需要“微妙”的权衡，针对这个问题，基本处理原则是，尽量保持接口的可复用性，但针对特殊情况，允许提供冗余的门面接口，来提供更易用的接口。



















